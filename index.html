<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Security: Strict CSP for static app; allows inline <style> only (theme), blocks remote scripts. -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'none';
        script-src 'self';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self' https://accounts.google.com https://oauth2.googleapis.com https://rpc.mainnet.near.org https://rpc.testnet.near.org https://rpc.mainnet.fastnear.com https://rpc.testnet.fastnear.com https://archival-rpc.mainnet.fastnear.com https://archival-rpc.testnet.fastnear.com https://*.near.org http://localhost:* ws: wss:;
        font-src 'self';
        base-uri 'none';
        frame-ancestors 'none';
    ">

    <title>NEARx - NEAR Blockchain Viewer</title>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #0b0b0b;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        #canvas_parent {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            outline: none;
            user-select: none;
        }

        #canvas_parent:focus {
            outline: 2px solid rgba(107, 163, 216, 0.3);
            outline-offset: -2px;
        }

        /* Canvas for egui rendering */
        #canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        /* Ratzilla attaches a <pre> or canvas; ensure monospace + nice metrics */
        pre, canvas {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            line-height: 1.0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* Loading indicator */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            font-family: monospace;
            z-index: 1000;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Hide loading when WASM calls hideLoading() */
        .loading.hidden {
            display: none;
        }

        /* Hidden input for IME / composition events (future-proofing) */
        #ime {
            position: absolute;
            left: -9999px;
            top: -9999px;
            opacity: 0;
            pointer-events: none;
        }

        /* Info bar at the top */
        .info-bar {
            background: #2d2d2d;
            color: #aaa;
            padding: 8px 16px;
            font-size: 12px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-bar a {
            color: #6ba3d8;
            text-decoration: none;
        }

        .info-bar a:hover {
            text-decoration: underline;
        }

        .info-bar .status {
            display: flex;
            gap: 16px;
        }
    </style>
</head>
<body>
    <!-- Canvas container for eframe WebRunner -->
    <canvas id="nearx_canvas" style="width:100%;height:100%;position:fixed;inset:0;"></canvas>

    <!-- Hidden input for IME / composition events (future-proofing) -->
    <input id="ime" type="text" autocomplete="off" />

    <!-- Trunk will inject the WASM loader script here -->
    <link data-trunk rel="rust" data-bin="nearx-web" />

    <!-- Optional: allow browser builds to hand off to desktop app -->
    <link data-trunk rel="copy-file" href="web/open_desktop.js" />
    <script src="open_desktop.js"></script>

    <!-- Authentication bridge (Google OAuth + Magic link) -->
    <link data-trunk rel="copy-file" href="web/auth.js" />
    <script defer src="auth.js"></script>

    <!-- Router shim for auth callback handling (#/auth/callback?...) -->
    <link data-trunk rel="copy-file" href="web/router_shim.js" />
    <script defer src="router_shim.js"></script>

    <script>
        // Update status message
        function updateStatus(msg) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = msg;
            }
        }

        // Hide loading screen (called from WASM when ready)
        window.hideLoading = function() {
            const loadingEl = document.querySelector('.loading');
            if (loadingEl) {
                loadingEl.classList.add('hidden');
            }
            updateStatus('Connected to RPC');
        };

        // Show initial loading status
        updateStatus('Loading WASM...');

        // Configuration (localStorage > URL params > defaults)
        //
        // RECOMMENDED: Set via localStorage (persists across sessions):
        //   localStorage.setItem('RPC_BEARER', 'your_fastnear_token_here');
        //   localStorage.setItem('RPC_URL', 'https://rpc.mainnet.fastnear.com/');
        //
        // ALTERNATIVE: Use URL parameters (one-time override):
        //   ?rpc=<url>          - RPC endpoint URL
        //   ?token=<token>      - FastNEAR auth token (overrides localStorage)
        //   ?filter=<account>   - Default account filter
        //   ?network=<network>  - Network name
        //
        // Example: http://localhost:8080?token=YOUR_TOKEN&rpc=https://rpc.mainnet.fastnear.com/
        const params = new URLSearchParams(window.location.search);
        const rpc = params.get('rpc') || 'mainnet';
        const filter = params.get('filter') || 'intents.near';
        const token = params.get('token') ? `${params.get('token').substring(0, 8)}...` : 'none';

        console.log('Ratacat starting with config:', { rpc, filter, token });

        // Note: Key event handling is now done in WASM code
        // (prevent_default_for_terminal_keys function)

        // Note: Resize handling is now done in WASM code
        // (install_event_listeners function)

        // Note: App initialization is now handled entirely in Rust
        // The #[wasm_bindgen(start)] function runs automatically when WASM loads
        // It waits for DOM ready internally and starts the app
    </script>
</body>
</html>
