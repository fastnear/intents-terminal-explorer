<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEARx - NEAR Blockchain Viewer (DOM)</title>

    <!-- Theme CSS variables (unified with Rust theme) -->
    <link data-trunk rel="copy-file" href="web/theme.css" />
    <link rel="stylesheet" href="theme.css" />

    <!-- App CSS (DOM-specific styles) -->
    <link data-trunk rel="copy-file" href="web/app.css" />
    <link rel="stylesheet" href="app.css" />

    <style>
        /* Page-specific overrides */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Status bar at top */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-family: monospace;
            font-size: 12px;
            color: #888;
            z-index: 2000;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            margin-right: 8px;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-indicator.connected {
            background: #4CAF50;
            animation: none;
        }

        .status-indicator.error {
            background: #f44336;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }

        .status-text {
            flex: 1;
        }

        .status-help {
            font-size: 11px;
            color: #666;
        }

        /* Loading screen */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text);
            font-family: inherit;
            font-size: 18px;
            z-index: 1000;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .loading.hidden {
            display: none;
        }
    </style>

    <!-- Tauri deep link bridge (safe no-op on plain web) -->
    <link data-trunk rel="copy-file" href="web/deep_link.js" />
    <script defer src="deep_link.js"></script>

    <!-- WASM error guard (dev helper - surfaces errors inline) -->
    <link data-trunk rel="copy-file" href="web/wasm_guard.js" />
    <script defer src="wasm_guard.js"></script>
</head>
<body>
    <!-- Status bar -->
    <div class="status-bar">
        <div class="status-indicator" id="status-indicator"></div>
        <span class="status-text" id="status-text">Initializing...</span>
        <span class="status-help">Press F12 for debug console</span>
    </div>

    <!-- App root -->
    <div id="app-root">
        <!-- Top bar (filter + auth) -->
        <div id="top-bar">
            <input
                type="text"
                id="filter-input"
                placeholder="Filter (acct:â€¦, action:â€¦, method:â€¦ ; comma AND)"
            />
            <div id="auth-container">
                <!-- Auth buttons will be rendered here -->
            </div>
        </div>

        <!-- Main content -->
        <div id="main-content">
            <!-- Top row (Blocks + Txs) -->
            <div id="row-top">
                <div id="pane-blocks" class="pane pane-blocks">
                    <!-- Rendered by app.js -->
                </div>
                <div id="pane-txs" class="pane pane-txs">
                    <!-- Rendered by app.js -->
                </div>
            </div>

            <!-- Bottom row (Details) -->
            <div id="row-bottom">
                <div id="pane-details" class="pane pane-details">
                    <!-- Rendered by app.js -->
                </div>
            </div>
        </div>
    </div>

    <div class="loading">Loading NEARx</div>

    <script>
        // Status bar management
        function updateStatus(message, state = 'loading') {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');

            if (text) text.textContent = message;
            if (indicator) {
                indicator.className = 'status-indicator';
                if (state === 'connected') indicator.classList.add('connected');
                else if (state === 'error') indicator.classList.add('error');
            }
        }

        // Export status updater for WASM to call
        window.updateStatus = updateStatus;

        // Configuration logging (same as egui version)
        const params = new URLSearchParams(window.location.search);
        const rpc = params.get('rpc') || localStorage.getItem('RPC_URL') || 'https://rpc.mainnet.fastnear.com/';
        const filter = params.get('filter') || localStorage.getItem('DEFAULT_FILTER') || '';
        const hasToken = params.get('token') || localStorage.getItem('RPC_BEARER');
        const token = hasToken ? `${hasToken.substring(0, 8)}...` : 'none';

        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ¦€ NEARx Configuration (DOM mode):');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('  RPC Endpoint:', rpc);
        console.log('  Auth Token:', token);
        console.log('  Default Filter:', filter || '(empty - show all)');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // Warn if no auth token
        if (!hasToken) {
            console.warn('âš ï¸  NO AUTH TOKEN CONFIGURED');
            console.warn('Set via: localStorage.setItem("RPC_BEARER", "your_token_here");');
            updateStatus('âš ï¸ No auth token - may hit rate limits', 'error');
        }
    </script>

    <!-- Clipboard bridge (works in web, Tauri, and extension contexts) -->
    <link data-trunk rel="copy-file" href="web/platform.js" />
    <script src="platform.js"></script>

    <!-- App loader (ES module) -->
    <link data-trunk rel="copy-file" href="web/app.js" />
    <script type="module" src="app.js"></script>

    <!-- Trunk will inject the WASM loader script here -->
    <link data-trunk rel="rust" data-bin="nearx-web-dom" data-cargo-no-default-features data-cargo-features="egui-web" />
</body>
</html>
