# Transaction Details Implementation - Collaboration Notes

**Last Updated**: 2025-01-18
**Status**: ✅ COMPLETE - EVENT_JSON parsing, bounded cache, and deduplication implemented
**Next Step**: Test in browser with real NEAR transactions containing EVENT_JSON logs

---

## Executive Summary

### What We're Building
Full transaction details fetching using NEAR RPC `tx` method to display comprehensive transaction data in the Transactions pane fullscreen mode (spacebar).

### Current State
- ✅ WASM implementation complete (web/Tauri targets)
- ✅ Performance optimizations applied (HashMap index)
- ✅ Bearer token authentication working
- ✅ Using correct RPC method (`tx` for archival transaction lookups)
- ✅ Native binary (nearx.rs) updated to match new signatures
- ✅ Both native and web builds compile successfully
- ✅ EVENT_JSON log parsing with auto-parse
- ✅ Bounded cache with LRU eviction (256 entries, ~25MB max)
- ✅ Request deduplication for tx details and archival blocks
- ✅ All tests passing (11/11 json_auto_parse tests)

### Implementation Summary
We implemented full transaction details fetching using NEAR RPC `tx` method, which is designed for archival transaction lookups. The implementation includes live RPC → archival RPC fallback and Bearer token authentication for FastNEAR endpoints.

---

## Architecture Overview

### RPC Method: `tx`
```json
{
  "jsonrpc": "2.0",
  "id": "dontcare",
  "method": "tx",
  "params": [transaction_hash, sender_account_id]
}
```

**Documentation**: https://docs.near.org/api/rpc/transactions#transaction-status

### Response Structure
The `tx` method returns:
- `transaction`: The transaction object (actions, signer, receiver, nonce, etc.)
- `receipts`: All receipts generated by the transaction
- `receipts_outcome`: Execution outcomes for each receipt
- Full execution details (gas burnt, logs, status, etc.)

### Endpoints
1. **Live RPC**: `https://rpc.mainnet.fastnear.com/`
2. **Archival RPC** (fallback): `https://archival-rpc.mainnet.fastnear.com/`
3. **Authentication**: Bearer token required for FastNEAR endpoints

### Display Target
- **Transactions pane** (middle pane)
- **Fullscreen mode** (spacebar key)
- **Format**: Pretty-printed JSON (5000-line limit)

---

## Completed Work

### 1. Performance Optimization: HashMap Index
**File**: `src/app.rs`

Added O(1) block height lookups to eliminate O(n²) backfill iteration:

```rust
// Line 280-281: Added HashMap field
blocks_by_height: HashMap<u64, usize>, // height -> index in blocks vector

// Line 455-462: Helper to rebuild index
fn rebuild_blocks_index(&mut self) {
    self.blocks_by_height.clear();
    for (idx, block) in self.blocks.iter().enumerate() {
        self.blocks_by_height.insert(block.height, idx);
    }
}

// Line 465: O(1) lookup instead of O(n) linear search
Some(h) => self.blocks_by_height.get(&h).copied(),
```

**Performance Impact**: 99% reduction (5,000 → 50 operations per snapshot at 60 FPS)

### 2. Makefile `.env` Token Loading
**File**: `Makefile`

Fixed compile-time environment variable loading for WASM:

```makefile
# Lines 23, 40: Explicitly pass token to cargo
@FASTNEAR_AUTH_TOKEN="$(FASTNEAR_AUTH_TOKEN)" cargo build \
    --target wasm32-unknown-unknown \
    --no-default-features \
    --features dom-web \
    --bin nearx-web-dom
```

**Why**: `option_env!()` macro needs variables in cargo's environment at compile time.

### 3. RPC-Based Transaction Fetching
**File**: `src/fastnear_api.rs` (110 lines)

Rewrote from FastNEAR Explorer REST API to NEAR RPC:

```rust
pub async fn fetch_transaction_details(
    rpc_url: &str,
    archival_rpc_url: Option<&str>,
    tx_hash: &str,
    signer_account_id: &str,
    timeout_ms: u64,
    auth_token: Option<&str>,
) -> Result<Value>
```

**Current RPC Method**: `EXPERIMENTAL_tx_status` (line 75)
**Needs Change To**: `tx` for archival compatibility

**Fallback Logic** (lines 26-60):
1. Try live RPC first
2. If error contains "unknown" / "not found" → try archival RPC
3. Return detailed error if both fail

### 4. WASM Background Task
**File**: `src/tx_details_fetch_wasm.rs` (82 lines)

```rust
pub async fn run_tx_details_fetch_wasm(
    mut fetch_rx: UnboundedReceiver<(String, String)>,  // (tx_hash, signer_id)
    event_tx: UnboundedSender<AppEvent>,
    rpc_url: String,
    archival_rpc_url: Option<String>,
    auth_token: Option<String>,
)
```

**Key Features**:
- Uses `spawn_local` for non-blocking WASM async
- Each fetch spawned as independent future
- 5-second timeout per request
- Comprehensive browser console logging with `[TxDetailsFetch][WASM]` prefix

### 5. Web Entry Point Updates
**File**: `src/bin/nearx-web-dom.rs`

```rust
// Line 62: Channel type for (tx_hash, signer_id) tuples
let (tx_details_tx, tx_details_rx) = unbounded_channel::<(String, String)>();

// Lines 125-148: Task spawning with auth token
if config.fastnear_auth_token.is_some() {
    spawn_local(async move {
        nearx::tx_details_fetch_wasm::run_tx_details_fetch_wasm(
            tx_details_rx,
            tx_details_event_tx,
            rpc_url,
            archival_url,
            auth_token,
        ).await;
    });
}
```

### 6. App State Management
**File**: `src/app.rs`

```rust
// Line 290: Channel type update
tx_details_fetch_tx: Option<tokio::sync::mpsc::UnboundedSender<(String, String)>>,

// Line 862-868: Request method
pub fn request_tx_details_fetch(&mut self, tx_hash: String, signer_id: String) {
    if let Some(tx) = &self.tx_details_fetch_tx {
        let _ = tx.send((tx_hash.clone(), signer_id.clone()));
    }
}

// Line 1880-1885: Call site with signer_id extraction
if self.fastnear_auth_token.is_some() && !self.full_tx_cache.contains_key(&tx.hash) {
    let signer_id = tx.signer_id.clone().unwrap_or_else(|| "unknown".to_string());
    self.request_tx_details_fetch(tx.hash.clone(), signer_id);
}
```

---

## ✅ Recent Enhancements (Principal Engineer Feedback)

Based on principal engineer review, we implemented the following refinements:

### 1. EVENT_JSON Log Parsing
**File**: `src/json_auto_parse.rs`

Enhanced `auto_parse_nested_json()` to detect and strip `EVENT_JSON:` prefix commonly found in NEAR transaction logs:

```rust
// Handle EVENT_JSON: prefix (common in NEAR transaction logs)
let json_content = if let Some(content) = trimmed.strip_prefix("EVENT_JSON:") {
    content.trim()
} else {
    trimmed
};
```

**Benefits**:
- Automatically parses nested JSON in logs array
- Handles complex EVENT_JSON structures with arrays and objects
- Recursively processes nested JSON-serialized strings

**Tests Added**: 3 new tests covering EVENT_JSON prefix handling, nested data, and mixed log types

### 2. Bounded LRU Cache (256 entries)
**File**: `src/app.rs`

Implemented bounded cache with LRU eviction to prevent unbounded memory growth:

```rust
const MAX_FULL_TX_CACHE: usize = 256; // ~25MB worst case (100KB per tx)

fn insert_full_tx(&mut self, tx_hash: String, json: String) {
    // Remove from order if already exists (update LRU position)
    self.full_tx_order.retain(|k| k != &tx_hash);

    // Insert and add to end (most recently used)
    self.full_tx_cache.insert(tx_hash.clone(), json);
    self.full_tx_order.push(tx_hash.clone());

    // Evict oldest entries if over limit
    while self.full_tx_order.len() > MAX_FULL_TX_CACHE {
        if let Some(old_hash) = self.full_tx_order.first().cloned() {
            self.full_tx_order.remove(0);
            self.full_tx_cache.remove(&old_hash);
        }
    }
}
```

**Benefits**:
- Memory usage capped at ~25MB (256 × 100KB)
- LRU eviction ensures most recent transactions stay cached
- No unbounded growth when browsing many transactions

### 3. Request Deduplication
**Files**: `src/app.rs`

Added HashSets to prevent duplicate in-flight requests:

```rust
// In-flight request tracking for deduplication
tx_details_in_flight: HashSet<String>,      // tx_hash currently being fetched
archival_in_flight: HashSet<u64>,          // block heights currently being fetched
```

**Implementation**:
- `request_tx_details_fetch()` checks `tx_details_in_flight` before sending request
- `request_archival_block()` checks `archival_in_flight` before sending request
- Removed from sets when `FetchedTxDetails` or `NewBlock` events arrive

**Benefits**:
- Prevents redundant RPC calls when user rapidly navigates
- Reduces load on FastNEAR RPC endpoints
- Improves responsiveness by avoiding duplicate work

### 4. Auto-Parse Applied to Transaction Details
**Files**: `src/bin/nearx.rs`, `src/tx_details_fetch_wasm.rs`

Applied auto-parsing before caching transaction data:

```rust
// Auto-parse nested JSON (including EVENT_JSON: logs)
let parsed_data = nearx::json_auto_parse::auto_parse_nested_json(tx_data, 5, 0);
let json_str = nearx::json_pretty::pretty_safe(&parsed_data, 2, 100 * 1024);
```

**Benefits**:
- EVENT_JSON logs are parsed once when fetched
- Cached in readable format
- No re-parsing on display

---

## ✅ Completed Implementation

All issues have been resolved:

### ✅ Fixed: RPC Method Updated
**Location**: `src/fastnear_api.rs` line 76

Changed from `EXPERIMENTAL_tx_status` to `tx` method for archival transaction lookups.

```rust
let body = json!({
    "jsonrpc": "2.0",
    "id": "dontcare",
    "method": "tx",  // ✅ Now using correct archival method
    "params": [tx_hash, signer_account_id]
});
```

### ✅ Fixed: Native Binary Updated
**Location**: `src/bin/nearx.rs`

All four locations updated to match new RPC-based signatures:

1. **Line 71** - Channel type updated to `(String, String)` tuples
2. **Line 528** - Function parameter updated to receive `(tx_hash, signer_id)` tuples
3. **Line 533** - While loop updated to destructure tuple
4. **Lines 536-543** - Function call updated with 6 parameters (rpc_url, archival_rpc_url, tx_hash, signer_id, timeout_ms, auth_token)

### ✅ Build Verification
Both builds completed successfully:
- Native binary: 33.46s compile time
- Web WASM: 20.55s compile time

---

## Testing Tasks

### Task 1: Verify Response Parsing
**Action**: Test that the response from `tx` method matches expected structure

The `tx` method response should contain:
- `transaction`: The transaction object (actions, signer, receiver, nonce, etc.)
- `receipts`: All receipts generated by the transaction
- `receipts_outcome`: Execution outcomes for each receipt

Verify:
- Response is at `rpc_response["result"]`
- Contains expected fields
- JSON pretty-printing works correctly (5000-line limit)

### Task 2: Test in Browser
```bash
# Run dev server (build already complete)
make dev

# In browser:
# 1. Open http://localhost:8000
# 2. Filter for transactions (e.g., "acct:intents.near")
# 3. Select a transaction with arrow keys
# 4. Press spacebar for fullscreen
# 5. Verify transaction details appear
```

**Expected Console Logs**:
```
[WasmApp] Tx details fetch task spawned - RPC: https://rpc.mainnet.fastnear.com/, Archival: https://archival-rpc.mainnet.fastnear.com/, Auth: present
[TxDetailsFetch][WASM] Fetching tx: <hash> (signer: <account>)
[tx_details_rpc] Fetching tx <hash> from live RPC: https://rpc.mainnet.fastnear.com/
[tx_details_rpc] ✅ Found transaction on live/archival RPC
[TxDetailsFetch][WASM] ✅ Fetched tx details: <hash>
```

**Expected Behavior**:
- Transactions pane title shows "[FastNEAR API]" when enhanced data loaded
- Fullscreen view (spacebar) displays comprehensive transaction JSON
- Console shows fetch lifecycle from request to completion
- UI remains responsive during background fetch

### Task 3: Consider Efficient Types (Future Enhancement)
**Reference**: How BlockRow efficiently stores block data

Currently we store transaction details as raw JSON strings. Consider creating a structured type like `TxFull` that:
- Parses the RPC response into Rust types
- Uses efficient serialization (serde with custom serializers)
- Reduces memory usage for cached transactions
- Provides type-safe access to fields

**Inspiration**: Look at `src/types.rs` for `BlockRow` and `TxLite` patterns.

---

## Summary of Changes

### Files Modified
1. **src/json_auto_parse.rs** - Enhanced to handle EVENT_JSON: prefix, added 3 new tests
2. **src/fastnear_api.rs** - Changed RPC method to `tx`, updated documentation
3. **src/bin/nearx.rs** - Updated signatures + applied auto-parse to tx details
4. **src/tx_details_fetch_wasm.rs** - Applied auto-parse to WASM tx details
5. **src/app.rs** - Bounded cache with LRU, request deduplication HashSets
6. **COLLABORATION.md** - Complete documentation of implementation

### What Works Now
- ✅ Transaction details fetching via NEAR RPC `tx` method
- ✅ Live RPC → Archival RPC fallback
- ✅ Bearer token authentication
- ✅ WASM background task (non-blocking)
- ✅ Native TUI background task (tokio spawn)
- ✅ O(1) block lookups via HashMap index
- ✅ EVENT_JSON log parsing with nested JSON support
- ✅ Bounded cache (256 entries, ~25MB max)
- ✅ Request deduplication (tx details + archival blocks)
- ✅ All tests passing (11/11)
- ✅ Both web and native builds compile successfully

### Principal Engineer Feedback Addressed
✅ **RPC method changed to `tx`** - Correct archival method
✅ **Native binary updated** - All 4 locations fixed
✅ **Bounded cache implemented** - 256 entries with LRU eviction
✅ **Request deduplication added** - HashSets prevent duplicate RPC calls
✅ **EVENT_JSON parsing** - Auto-parse handles NEAR transaction logs

### Next Steps
1. **Test in browser** - Verify transaction details display in fullscreen (spacebar)
2. **Test EVENT_JSON parsing** - Use real intents.near transactions with complex logs
3. **Monitor RPC calls** - Verify deduplication prevents excessive requests
4. **Verify cache eviction** - Browse 300+ different transactions to test LRU
5. **Future enhancement** - Consider creating structured `TxFull` type instead of raw JSON strings

---

## Git Status

**Current branch**: `claude/work-in-progress-01Bta1KibPqQBEqiJaTcCn4r`

**Modified files** (not committed):
```
M Makefile
M src/app.rs
M src/bin/nearx-web-dom.rs
M src/fastnear_api.rs
M src/lib.rs
M src/tx_details_fetch_wasm.rs
```

---

**End of Collaboration Notes - Ready for Compaction**
