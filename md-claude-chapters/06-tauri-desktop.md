# Chapter 6: Tauri Desktop

This chapter covers the Tauri desktop application, including deep link handling, configuration, and platform-specific features.

## Overview

Native desktop application with deep link support for handling `nearx://` URLs. Built with Tauri v2, combining Rust backend with **DOM frontend** (same static site as web).

### Key Features
- **DOM-based UI**: Native web elements for consistent cross-platform UX
- **Deep link handler**: `nearx://` protocol (e.g., `nearx://v1/tx/ABC123`)
- **Single-instance enforcement**: Prevents duplicate app launches
- **Comprehensive debug logging**: 8-point waterfall for deep link tracing
- **DevTools integration**: Keyboard shortcuts + UI controls
- **Native host sidecar**: Browser extension integration support

### Frontend
Uses the same `web/` static site as the web build - pure DOM with WASM core, no canvas or WebGL. Configuration in `tauri.conf.json` points to `frontendDist: "../../web"`.

## Deep Link Architecture

Ratacat implements an **8-point color-coded debug logging waterfall** to trace deep link URLs through the system:

```
ðŸ”´ SINGLE-INSTANCE â†’ ðŸŸ  GET-CURRENT â†’ ðŸŸ¡ ON-OPEN-URL â†’ ðŸŸ¢ HANDLE-URLS
    â†’ ðŸ”µ NORMALIZE â†’ ðŸŸ£ PARSE-EVENT â†’ ðŸŸ¤ EMIT-OR-QUEUE â†’ âšª FRONTEND-INIT â†’ âš« ROUTE-EVENT
```

### Flow Explanation

1. **ðŸ”´ SINGLE-INSTANCE**: Tauri plugin intercepts new launches, captures `argv` on Windows/Linux
2. **ðŸŸ  GET-CURRENT**: Retrieves initial deep links from Tauri on first run (macOS primary method)
3. **ðŸŸ¡ ON-OPEN-URL**: macOS system callback when URL opens while app already running
4. **ðŸŸ¢ HANDLE-URLS**: Central processing function, receives raw URL strings
5. **ðŸ”µ NORMALIZE**: Cleans URLs (trim, lowercase scheme, strip trailing slashes)
6. **ðŸŸ£ PARSE-EVENT**: Extracts host/path/query into `DeepLinkEvent` struct
7. **ðŸŸ¤ EMIT-OR-QUEUE**: Emits to frontend if ready, queues if still initializing (prevents race conditions)
8. **âšª FRONTEND-INIT**: Frontend calls `get_queued_urls()` after DOM ready
9. **âš« ROUTE-EVENT**: JavaScript routes event to appropriate UI handler

### Example Output
```
ðŸŸ¢ [HANDLE-URLS] Processing 1 URL(s)
ðŸŸ¢ [HANDLE-URLS] URL[0]: "near://tx/ABC123?network=mainnet"
ðŸ”µ [NORMALIZE] Input raw: "near://tx/ABC123?network=mainnet"
ðŸ”µ [NORMALIZE] After scheme normalization: "near://tx/ABC123?network=mainnet"
ðŸŸ£ [PARSE-EVENT] âœ… Created DeepLinkEvent:
ðŸŸ£ [PARSE-EVENT]    host: "tx"
ðŸŸ£ [PARSE-EVENT]    path: ["ABC123"]
ðŸŸ£ [PARSE-EVENT]    query: {"network": "mainnet"}
ðŸŸ¤ [EMIT-OR-QUEUE] Frontend ready - emitting to window
âš« [ROUTE-EVENT] Received event: {"host":"tx","path":["ABC123"],"query":{"network":"mainnet"}}
```

## Configuration

### Bundle Identifier
`com.nearx.fast`
- **Note**: Bundle identifiers ending in `.app` are reserved by Apple
- Configured in `tauri-workspace/src-tauri/tauri.conf.json`

### Deep Link Scheme
`near://`
- Registered via `CFBundleURLTypes` in `Info.plist` (auto-generated by Tauri)
- Configured in `tauri.conf.json`:
  ```json
  "plugins": {
    "deep-link": {
      "desktop": {
        "schemes": ["near"]
      }
    }
  }
  ```

### Logging
- **Development**: `tauri-plugin-log` forwards Rust logs to browser DevTools console
- **Production**: Logs written to `~/Library/Logs/com.ratacat.fast/Ratacat.log` (macOS)
- Both: `env_logger` outputs to stdout/stderr

### Clipboard
- **Plugin**: `tauri-plugin-clipboard-manager` (v2.3+) - Official Tauri clipboard plugin
- **JavaScript Bridge**: `web/platform.js` calls `__TAURI__.invoke("copy_text", { text })` as first fallback
- **Command**: `copy_text` command in `lib.rs` using `ClipboardExt` trait
- **Graceful Degradation**: Falls back to Navigator API â†’ execCommand if plugin unavailable

## Build Process

### Standard Build
```bash
cd tauri-workspace
cargo tauri build
```

### Development Mode
```bash
# Run Tauri dev mode (frontend builds automatically)
cd tauri-workspace
cargo tauri dev
```

**Alternative**: Use the dev-deep-links.sh script for deep link testing (macOS):
```bash
./tauri-workspace/dev-deep-links.sh
```

### DevTools Access (4 methods)
1. **Keyboard**: `Cmd+Option+I` (macOS) or `F12` (Windows/Linux)
2. **UI Button**: Click "Toggle DevTools" button in app (requires `devtools` feature)
3. **Rust Commands**: `open_devtools()` / `close_devtools()` (requires `devtools` feature)
4. **Auto-open**: Automatically opens in debug builds

## Testing Deep Links

### ðŸŽ¯ Recommended: Use the tauri-dev.sh script (macOS only)

The `tauri-dev.sh` script solves the common issue where deep links open old app versions due to macOS Launch Services caching:

```bash
# Build debug bundle and register with Launch Services
./tauri-dev.sh

# Build, register, AND test with sample deep link
./tauri-dev.sh test

# Clear old registrations (useful if multiple versions installed)
./tauri-dev.sh clean

# Show help
./tauri-dev.sh --help
```

**What it does:**
1. Kills any running instances of NEARx
2. Builds a debug .app bundle (includes symbols, faster than release)
3. Clears macOS Launch Services cache
4. Copies bundle to /Applications
5. Registers the app from /Applications for `nearx://` URLs
6. Optionally tests with `nearx://v1/tx/ABC123`

### Manual Testing
```bash
# Open the app with a deep link
open 'nearx://v1/tx/ABC123'

# Or with multiple paths
open 'nearx://v1/account/alice.near'
```

### Verify in Logs
```bash
# Watch live logs (development)
# Check browser DevTools console

# View production logs (macOS)
tail -f ~/Library/Logs/com.fastnear.nearx/NEARx.log
```

## File Structure

```
tauri-workspace/
â”œâ”€â”€ src-tauri/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib.rs           # Core logic with 8-point debug waterfall
â”‚   â”‚   â””â”€â”€ main.rs          # Entry point (minimal, calls lib.rs)
â”‚   â”œâ”€â”€ Cargo.toml           # Dependencies + binary config
â”‚   â”œâ”€â”€ tauri.conf.json      # Tauri configuration
â”‚   â””â”€â”€ build.rs             # Tauri build script
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ index.html           # Frontend with deep link handler
â””â”€â”€ target/release/bundle/
    â””â”€â”€ macos/
        â””â”€â”€ Ratacat.app/
            â””â”€â”€ Contents/
                â”œâ”€â”€ Info.plist       # Auto-generated, includes CFBundleURLTypes
                â””â”€â”€ MacOS/
                    â””â”€â”€ nearx-tauri  # Binary executable
```

## Deep Link Event Structure

```rust
#[derive(Debug, Clone, serde::Serialize)]
pub struct DeepLinkEvent {
    pub host: String,                    // e.g., "tx", "account"
    pub path: Vec<String>,               // e.g., ["ABC123"], ["alice.near", "history"]
    pub query: HashMap<String, String>,  // e.g., {"network": "mainnet"}
}
```

**Example Parsing:**
- Input: `near://tx/ABC123?network=mainnet`
- Output:
  ```json
  {
    "host": "tx",
    "path": ["ABC123"],
    "query": {"network": "mainnet"}
  }
  ```

## Known Issues & Workarounds

### Issue 1: Tauri bundler tries to copy `.rs` files instead of binaries
- **Error**: `Failed to copy binary from "target/release/nearx-tauri.rs"`
- **Workaround**: Manual binary copy
- **Prevention**: Keep `src/bin/` clean, move unused binaries to `.bak`

### Issue 2: Bundle identifier restrictions
- **Error**: `Bundle identifier cannot end with .app (reserved by Apple)`
- **Solution**: Use `com.nearx.fast` instead of `com.ratacat.app`

### Issue 3: Old app captures deep links
- **Symptom**: Deep links open wrong app version
- **Solution**: Kill all instances, remove old app, re-register fresh build

### Issue 4: No logs appearing in DevTools
- **Cause**: Logger not initialized or plugin missing
- **Solution**: Ensure both `env_logger` and `tauri-plugin-log` in dependencies

## Integration with Browser Extension

The Tauri app includes a sidecar spawn utility for the native messaging host:

```rust
// Automatically spawns native-host binary when needed
// Located at: Contents/Resources/ratacat-native-host
// Configured in tauri.conf.json bundle.resources
```

This enables the browser extension to send `near://` deep links to the desktop app via native messaging, creating a seamless "Open in Ratacat" experience from transaction pages.

## Production Deployment

### macOS Considerations
1. **Code Signing**: Required for distribution outside App Store
2. **Notarization**: Required for Gatekeeper approval
3. **Universal Binary**: Build for both Intel and Apple Silicon
4. **Auto-updater**: Tauri supports built-in update mechanism

### Future Enhancements
- Windows/Linux deep link testing
- Auto-updater integration
- Code signing automation
- DMG installer with drag-to-Applications

## Next Steps

- For testing procedures, see [Chapter 7: Testing & Security](07-testing-security.md)
- For reference and troubleshooting, see [Chapter 8: Reference](08-reference.md)